<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M.A.M CET - Students Update Page Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css"> <!-- Ensure you have this file in the same directory -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPs_ETDj1ja8yVEOIPDzsQfqkfOFh9sKA",
            authDomain: "mamcet-ai.firebaseapp.com",
            projectId: "mamcet-ai",
            storageBucket: "mamcet-ai.appspot.com",
            messagingSenderId: "651882308996",
            appId: "1:651882308996:web:c19d4b0eb0591392cfe9d1",
            measurementId: "G-VQ12MPKH77"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.fetchStudents = async function() {
            const year = document.getElementById('yearSelect').value; // Get the selected year
            const studentsCollectionRef = collection(db, `students/${year}`); // Correct reference to year collection
            const snapshot = await getDocs(studentsCollectionRef);
            const tableBody = document.getElementById('studentTableBody');
            tableBody.innerHTML = ""; // Clear previous data

            snapshot.forEach(doc => {
                const row = document.createElement('tr');
                row.innerHTML = `<td><button onclick="showDetails('${doc.id}', '${year}')">${doc.id}</button></td>`;
                tableBody.appendChild(row);
            });
        }

        window.showDetails = async function(registrationNumber, year) {
            const studentDocRef = doc(db, `students/${year}/${registrationNumber}`); // Correct document reference
            const docSnap = await getDoc(studentDocRef);
            if (docSnap.exists()) {
                const details = docSnap.data();
                alert(JSON.stringify(details, null, 2)); // Show student details in an alert
            } else {
                alert("No such student!");
            }
        }

        window.updateStudent = async function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const studentDetails = Object.fromEntries(formData.entries());
            const year = studentDetails.year; // Get the year from the form

            // Create a document with registration number as the document ID
            const studentDocRef = doc(db, `students/${year}/${studentDetails.registrationNumber}`);
            
            try {
                await setDoc(studentDocRef, studentDetails);
                alert("Student details updated successfully!");
                event.target.reset();
                fetchStudents(); // Refresh the displayed student data
            } catch (error) {
                console.error("Error updating student details:", error);
                alert("Failed to update student details. Please try again.");
            }
        }
    </script>
</head>
<body>
    <h1>M.A.M CET - Students Update Page Admin Dashboard</h1>
    <form onsubmit="updateStudent(event)">
        <label for="registrationNumber">Registration Number:</label>
        <input type="text" id="registrationNumber" name="registrationNumber" required>
        
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>
        
        <label for="dob">Date of Birth:</label>
        <input type="date" id="dob" name="dob" required>
        
        <label for="bloodGroup">Blood Group:</label>
        <input type="text" id="bloodGroup" name="bloodGroup" required>
        
        <label for="department">Department:</label>
        <input type="text" id="department" name="department" required>
        
        <label for="gender">Gender:</label>
        <select id="gender" name="gender" required>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
        </select>

        <label for="year">Year:</label>
        <select id="year" name="year" required>
            <option value="1st year">1st Year</option>
            <option value="2nd year">2nd Year</option>
            <option value="3rd year">3rd Year</option>
            <option value="4th year">4th Year</option>
        </select>

        <button type="submit">Update Student</button>
    </form>

    <h2>All Students in Selected Year</h2>
    <select id="yearSelect" onchange="fetchStudents()">
        <option value="1st year">1st Year</option>
        <option value="2nd year">2nd Year</option>
        <option value="3rd year">3rd Year</option>
        <option value="4th year">4th Year</option>
    </select>
    
    <table>
        <thead>
            <tr>
                <th>Registration Number</th>
            </tr>
        </thead>
        <tbody id="studentTableBody">
            <!-- Student data will be displayed here -->
        </tbody>
    </table>

    <style>
        /* Add some styles to make it look professional */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        form {
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin: 10px 0 5px;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ccc;
        }
        th {
            background-color: #f8f8f8;
        }
    </style>
</body>
</html>
